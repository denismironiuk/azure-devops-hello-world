trigger:
  - main

pool:
  name: Default   # self-hosted –∞–≥–µ–Ω—Ç

variables:
  buildConfiguration: 'Release'
  buildVersion: '1.0.$(Build.BuildId)'
  artifactName: 'drop_$(Build.BuildNumber)'

steps:
# 1Ô∏è‚É£ –ö–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
- checkout: self

# 2Ô∏è‚É£ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ .NET SDK
- task: UseDotNet@2
  inputs:
    packageType: 'sdk'
    version: '9.0.x'

# 3Ô∏è‚É£ –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∞–Ω–∞–ª–∏–∑–∞ SonarQube
- task: SonarQubePrepare@5
  inputs:
    SonarQube: 'SonarQubeConnection'   # –∏–º—è service connection, —Å–æ–∑–¥–∞–Ω–Ω–æ–≥–æ —Ä–∞–Ω–µ–µ
    scannerMode: 'MSBuild'
    projectKey: 'HelloWorld'
    projectName: 'HelloWorld'
    projectVersion: '$(buildVersion)'
  displayName: 'üîç Prepare SonarQube Analysis'

# 4Ô∏è‚É£ –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
- script: |
    echo "üîß Restoring dependencies..."
    dotnet restore ./HelloWorld/HelloWorld.csproj
  displayName: "Restore dependencies"

# 5Ô∏è‚É£ –°–±–æ—Ä–∫–∞ –ø—Ä–æ–µ–∫—Ç–∞ —Å –≤–∫–ª—é—á—ë–Ω–Ω—ã–º –∞–Ω–∞–ª–∏–∑–æ–º
- script: |
    echo "‚öôÔ∏è Building project (with SonarQube)..."
    dotnet build ./HelloWorld/HelloWorld.csproj --configuration $(buildConfiguration)
  displayName: "Build project"

# 6Ô∏è‚É£ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ) –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤ —Å –∞–Ω–∞–ª–∏–∑–æ–º –ø–æ–∫—Ä—ã—Ç–∏—è
# - script: |
#     echo "üß™ Running tests..."
#     dotnet test ./HelloWorld/HelloWorld.csproj --configuration $(buildConfiguration) --collect:"XPlat Code Coverage"
#   displayName: "Run tests"

# 7Ô∏è‚É£ –ê–Ω–∞–ª–∏–∑ SonarQube
- task: SonarQubeAnalyze@5
  displayName: 'üìä Run SonarQube Analysis'

# 8Ô∏è‚É£ –ü—É–±–ª–∏–∫–∞—Ü–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –∞–Ω–∞–ª–∏–∑–∞
- task: SonarQubePublish@5
  inputs:
    pollingTimeoutSec: '300'
  displayName: 'üì¢ Publish SonarQube Quality Gate Result'

# 9Ô∏è‚É£ –ê—Ä—Ö–∏–≤–∞—Ü–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ —Å–±–æ—Ä–∫–∏
- task: ArchiveFiles@2
  inputs:
    rootFolderOrFile: '$(Build.ArtifactStagingDirectory)'
    includeRootFolder: false
    archiveType: 'zip'
    archiveFile: '$(Build.ArtifactStagingDirectory)/$(artifactName).zip'
    replaceExistingArchive: true
  displayName: "üì¶ Create versioned artifact archive"

# üîü –ü—É–±–ª–∏–∫–∞—Ü–∏—è –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–æ–≤ –≤ Azure DevOps
- task: PublishBuildArtifacts@1
  inputs:
    PathtoPublish: '$(Build.ArtifactStagingDirectory)/$(artifactName).zip'
    ArtifactName: '$(artifactName)'
    publishLocation: 'Container'
  displayName: "üöÄ Upload versioned artifact to Azure DevOps"
