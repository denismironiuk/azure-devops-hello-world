trigger:
  branches:
    include:
      - main 

pool:
  name: Default   # self-hosted –∞–≥–µ–Ω—Ç

variables:
  buildConfiguration: 'Release'
  buildVersion: '1.0.$(Build.BuildId)'
  artifactName: 'HelloWorld-$(buildVersion)'
  NUGET_PACKAGES: $(Pipeline.Workspace)/.nuget/packages

stages:
- stage: Build
  displayName: 'üèóÔ∏è Build & Analyze'
  jobs:
  - job: BuildJob
    displayName: 'Build and SonarQube Analysis'
    steps:
    
    # 1Ô∏è‚É£ –ö–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
    - checkout: self
      displayName: 'üì• Checkout repository'
        # üß± –°–æ–∑–¥–∞—ë–º –∫–∞—Ç–∞–ª–æ–≥ –¥–ª—è NuGet –ø–∞–∫–µ—Ç–æ–≤ (–∏–Ω–∞—á–µ Cache —É–ø–∞–¥—ë—Ç)
    - script: |
        mkdir -p $(Pipeline.Workspace)/.nuget/packages
        echo "‚úÖ Created directory: $(Pipeline.Workspace)/.nuget/packages"
      displayName: 'üìÇ Ensure NuGet cache directory exists'

    # üíæ –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ NuGet –ø–∞–∫–µ—Ç–æ–≤
    - task: Cache@2
      inputs:
        key: 'nuget | "$(Agent.OS)" | **/HelloWorld.csproj'
        restoreKeys: |
          nuget | "$(Agent.OS)"
        path: $(Pipeline.Workspace)/.nuget/packages
      displayName: 'üíæ Cache NuGet packages'
      continueOnError: true

    # 2Ô∏è‚É£ –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ NuGet –ø–∞–∫–µ—Ç–æ–≤
    - task: Cache@2
      inputs:
        key: 'nuget | "$(Agent.OS)" | **/HelloWorld.csproj'
        restoreKeys: |
          nuget | "$(Agent.OS)"
        path: $(NUGET_PACKAGES)
      displayName: 'üíæ Cache NuGet packages'
      continueOnError: true
    
    # 3Ô∏è‚É£ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ .NET SDK
    - task: UseDotNet@2
      inputs:
        packageType: 'sdk'
        version: '9.0.x'
      displayName: '‚öôÔ∏è Install .NET 9 SDK'
        # 5Ô∏è‚É£ –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ SonarQube
    - task: SonarQubePrepare@5
      inputs:
        SonarQube: 'SonarQubeConnection'
        scannerMode: 'MSBuild'
        projectKey: 'HelloWorld'
        projectName: 'HelloWorld'
        projectVersion: '$(buildVersion)'
        extraProperties: |
          sonar.projectBaseDir=$(Build.SourcesDirectory)
          sonar.sourceEncoding=UTF-8
          sonar.cs.opencover.reportsPaths=$(Agent.TempDirectory)/**/coverage.opencover.xml
          sonar.coverage.exclusions=**/*Tests.cs,**/Program.cs
      displayName: 'üîç Prepare SonarQube Analysis (Community Edition)'

    # üßπ –û—á–∏—Å—Ç–∫–∞ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –ø–æ—Å–ª–µ Prepare
    - script: |
        echo "üßπ Cleaning SonarQube parameters for Community Edition..."
        if [ -n "$SONARQUBE_SCANNER_PARAMS" ]; then
          CLEANED=$(echo "$SONARQUBE_SCANNER_PARAMS" \
            | sed 's/"sonar\.branch\.name":"[^"]*",\?//g' \
            | sed 's/"sonar\.pullrequest\.[^"]*":"[^"]*",\?//g' \
            | sed 's/,\s*}/}/g' \
            | sed 's/{\s*,/{/g')
          echo "‚úÖ Cleaned SONARQUBE_SCANNER_PARAMS applied."
          echo "##vso[task.setvariable variable=SONARQUBE_SCANNER_PARAMS]$CLEANED"
        else
          echo "‚ÑπÔ∏è No SONARQUBE_SCANNER_PARAMS found, skipping cleanup."
        fi
      displayName: 'üßπ Fix SonarQube scanner parameters (Community Edition)'
      condition: succeeded()

    
    # 6Ô∏è‚É£ –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
    - script: |
        echo "üîß Restoring dependencies..."
        dotnet restore ./HelloWorld/HelloWorld.csproj
      displayName: 'üì¶ Restore dependencies'
    
    # 7Ô∏è‚É£ –°–±–æ—Ä–∫–∞ –ø—Ä–æ–µ–∫—Ç–∞
    - script: |
        echo "‚öôÔ∏è Building project..."
        dotnet build ./HelloWorld/HelloWorld.csproj \
          --configuration $(buildConfiguration) \
          --no-restore \
          /p:Version=$(buildVersion)
      displayName: 'üî® Build project'
    
    # 8Ô∏è‚É£ –¢–µ—Å—Ç—ã —Å –ø–æ–∫—Ä—ã—Ç–∏–µ–º
    - script: |
        echo "üß™ Running tests with code coverage..."
        dotnet test ./HelloWorld/HelloWorld.csproj \
          --configuration $(buildConfiguration) \
          --no-build \
          --logger trx \
          --collect:"XPlat Code Coverage" \
          --results-directory $(Agent.TempDirectory)/TestResults \
          -- DataCollectionRunSettings.DataCollectors.DataCollector.Configuration.Format=opencover
      displayName: 'üß™ Run tests with coverage'
      continueOnError: false
    
    # 9Ô∏è‚É£ –ü—É–±–ª–∏–∫–∞—Ü–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ —Ç–µ—Å—Ç–æ–≤
    - task: PublishTestResults@2
      inputs:
        testResultsFormat: 'VSTest'
        testResultsFiles: '$(Agent.TempDirectory)/TestResults/**/*.trx'
        mergeTestResults: true
        failTaskOnFailedTests: true
      displayName: 'üìä Publish test results'
      condition: succeededOrFailed()
    
    # üîü –ü—É–±–ª–∏–∫–∞—Ü–∏—è –ø–æ–∫—Ä—ã—Ç–∏—è
    - task: PublishCodeCoverageResults@1
      inputs:
        codeCoverageTool: 'Cobertura'
        summaryFileLocation: '$(Agent.TempDirectory)/TestResults/**/coverage.cobertura.xml'
      displayName: 'üìà Publish code coverage'
      condition: succeededOrFailed()

    # 1Ô∏è‚É£1Ô∏è‚É£ –ê–Ω–∞–ª–∏–∑ SonarQube
    - task: SonarQubeAnalyze@5
      displayName: 'üìä Run SonarQube Analysis'

    # 1Ô∏è‚É£2Ô∏è‚É£ –ü—É–±–ª–∏–∫–∞—Ü–∏—è Quality Gate
    - task: SonarQubePublish@5
      inputs:
        pollingTimeoutSec: '300'
      displayName: 'üì¢ Publish Quality Gate Result'
    
    # 1Ô∏è‚É£3Ô∏è‚É£ –ü—É–±–ª–∏–∫–∞—Ü–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
    - script: |
        echo "üìÅ Publishing application..."
        dotnet publish ./HelloWorld/HelloWorld.csproj \
          --configuration $(buildConfiguration) \
          --output $(Build.ArtifactStagingDirectory)/app \
          --no-build \
          /p:Version=$(buildVersion)
      displayName: 'üì§ Publish application'
    
    # 1Ô∏è‚É£4Ô∏è‚É£ –ê—Ä—Ö–∏–≤–∞—Ü–∏—è
    - task: ArchiveFiles@2
      inputs:
        rootFolderOrFile: '$(Build.ArtifactStagingDirectory)/app'
        includeRootFolder: false
        archiveType: 'zip'
        archiveFile: '$(Build.ArtifactStagingDirectory)/$(artifactName).zip'
        replaceExistingArchive: true
      displayName: 'üì¶ Create artifact archive'
    
    # 1Ô∏è‚É£5Ô∏è‚É£ –ü—É–±–ª–∏–∫–∞—Ü–∏—è –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–æ–≤
    - task: PublishBuildArtifacts@1
      inputs:
        PathtoPublish: '$(Build.ArtifactStagingDirectory)/$(artifactName).zip'
        ArtifactName: '$(artifactName)'
        publishLocation: 'Container'
      displayName: 'üöÄ Upload artifact to Azure DevOps'
    
    # 1Ô∏è‚É£6Ô∏è‚É£ –í—ã–≤–æ–¥ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏
    - script: |
        echo "=========================================="
        echo "‚úÖ Build completed successfully!"
        echo "=========================================="
        echo "üìå Build Version: $(buildVersion)"
        echo "üìå Artifact Name: $(artifactName).zip"
        echo "üìå Configuration: $(buildConfiguration)"
        echo "=========================================="
      displayName: 'üìã Build Summary'
      condition: succeeded()
